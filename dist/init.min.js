var wi={css:{ELEMENT:"chrome-extension-wi-element",COLOR_SELECT_CLASS:"chrome-extension-wi-color_select",CLOSE_BUTTON_CLASS:"chrome-extension-wi-close_button",CONTENT_BOX_CLASS:"chrome-extension-wi-content_box",DATA_BOX_CLASS:"chrome-extension-wi-data_box",DATA_FIELD:"chrome-extension-wi-data_field",FILLER_BOX_CLASS:"chrome-extension-wi-filler_box"},current:{active:!1,contentBox:$(),element:$(),elements:$(),addElements:function(e){e.length>0&&(e.addClass(wi.css.ELEMENT).on("click",wi.events.elementClick),this.elements=this.elements.add(e))},resetElements:function(){this.elements.removeClass(wi.css.ELEMENT).off("click",wi.events.elementClick),this.elements=$()},toggleStatus:function(){var e="",t=wi.elements;this.active=!this.active,this.active?(e="on",this.addElements($(t.selector).filter(t.filter))):(e="off",this.resetElements(),wi.box.remove()),$(document)[e]("click",wi.events.documentClicked)[e]("DOMNodeInserted",wi.events.elementCreated),$(window)[e]("keydown",wi.events.keyPress)[e]("resize scroll",wi.events.windowResizeOrScroll)}},elements:{selector:"",containers:"",filter:"",CONTENT:["ARTICLE","ASIDE","DIV","FIELDSET","FOOTER","FORM","HEADER","MAIN","NAV","OL","SECTION","TABLE","UL"],FORM:["BUTTON","INPUT","KEYGEN","OUTPUT","SELECT","TEXTAREA"],GAME:["CANVAS"],MULTIMEDIA:["AUDIO","IMG","VIDEO"],REFERENCE:["A","IFRAME","EMBED","OBJECT"],TEXT:["ABBR","ADDRESS","B","BDI","BDO","BLOCKQUOTE","CAPTION","CITE","CODE","DD","DEL","DIV","DFN","DIALOG","DT","EM","FIGCAPTION","H1","H2","H3","H4","H5","H6","I","INS","LABEL","LEGEND","LI","MARK","P","PRE","Q","S","SAMP","SMALL","SPAN","STRONG","SUB","SUMMARY","SUP","TIME","TH","TD","U","VAR"],init:function(){this.selector=this.REFERENCE.join(",")+","+this.TEXT.join(",")+","+this.MULTIMEDIA.join(","),this.containers=this.CONTENT.join(","),this.filter=":not(:has("+this.containers+"))"}},events:{documentClicked:function(e){wi.current.active&&wi.box.remove()},elementCreated:function(e){if(wi.current.active){var t=$(e.target),i=wi.elements;if(!t.hasClass(wi.css.CONTENT_BOX_CLASS)){var n=t.find(i.selector).filter(i.filter).filter(":not(."+wi.css.ELEMENT+")");!t.hasClass(wi.css.ELEMENT)&&t.is(i.selector)&&0==t.find(i.containers).length&&(n=n.add(t)),wi.current.addElements(n)}}},elementClick:function(e){wi.current.active&&(e.preventDefault(),e.stopPropagation(),wi.box.remove(),wi.box.add($(e.target)))},keyPress:function(e){console.log(e.keyCode),wi.current.active&&27==e.keyCode&&chrome.extension.sendRequest({action:"toggleIcon"})},windowResizeOrScroll:function(e){wi.current.active&&wi.current.contentBox.length>0&&wi.current.element.length>0&&wi.box.setStyles(wi.current.contentBox,wi.current.element)}},box:{add:function(e){for(var t=$('<div class="'+wi.css.CONTENT_BOX_CLASS+'"></div>'),i=$('<div class="'+wi.css.DATA_BOX_CLASS+'"></div>'),n=$('<div class="'+wi.css.FILLER_BOX_CLASS+'"></div>'),s=$('<div class="'+wi.css.CLOSE_BUTTON_CLASS+'">X</div>'),o=this.getMetadata(e),r="<form>",l=0;l<o.length;l++){var a=o[l];a.value&&(r+='<div class="'+wi.css.DATA_FIELD+'"><label for="'+a.id+'">'+a.label+":</label>"+(-1!=a.id.indexOf("src")?'<a href="'+a.value+'" target="_blank">'+a.value+"</a>":"<span>"+a.value+"</span>")+(-1!=a.id.indexOf("color")?'<select class="'+wi.css.COLOR_SELECT_CLASS+'"><option value="hex">HEX</option><option value="rgb" selected>RGB</option></select>':"")+"</div>")}r+="<form>",t.on("click",function(e){e.stopPropagation()}).on("change","select."+wi.css.COLOR_SELECT_CLASS,function(e){var t=$(this),i=t.prev(),n=t.val(),s=i.data("rgb")||i.text(),o=i.data("hex")||wi.utils.colors.rgb2hex(s);switch(i.data({rgb:s,hex:o}),n){case"rgb":i.text(s);break;case"hex":i.text(o)}}),s.on("click",wi.events.documentClicked),i.append(r),t.append(s),t.append(i),t.append(n),$("body").append(t),this.setStyles(t,e),wi.current.contentBox=t,wi.current.element=e},getMetadata:function(e){var t=[],i=[],n=[],s=e[0].tagName,o=e.text(),r=wi.utils.parseColor(e.css("color")),l=wi.utils.parseColor(e.css("background-color")),a=wi.utils.parseBackgroundImage(e.css("background-image")),c=wi.utils.parseSourceURL(e.attr("href")),d=wi.utils.parseSourceURL(e.attr("src")||e.children("source").attr("src"));return o&&"string"==typeof o&&(t=[{id:"font",label:chrome.i18n.getMessage("fieldFontLabel"),value:e.css("font-family")},{id:"fsize",label:chrome.i18n.getMessage("fieldFSizeLabel"),value:e.css("font-size")},{id:"text-color",label:chrome.i18n.getMessage("fieldTextColorLabel"),value:r},{id:"background-color",label:chrome.i18n.getMessage("fieldBackgroundColorLabel"),value:l}]),-1!=wi.elements.REFERENCE.indexOf(s)&&(i=[{id:"src",label:chrome.i18n.getMessage("fieldSourceLabel"),value:c||d},{id:"lang",label:chrome.i18n.getMessage("fieldLangLabel"),value:e.attr("hreflang")}]),(-1!=wi.elements.MULTIMEDIA.indexOf(s)||a)&&(n=[{id:"width",label:chrome.i18n.getMessage("fieldWidthLabel"),value:e.width()+"px"},{id:"height",label:chrome.i18n.getMessage("fieldHeightLabel"),value:e.height()+"px"},{id:"src",label:chrome.i18n.getMessage("fieldSourceLabel"),value:d},{id:"desc",label:chrome.i18n.getMessage("fieldDescLabel"),value:e.attr("alt")},{id:"image-src",label:chrome.i18n.getMessage("fieldBackgroundImageLabel"),value:a}]),[].concat(t).concat(i).concat(n)},setStyles:function(e,t){var i=e.children("."+wi.css.DATA_BOX_CLASS),n=e.children("."+wi.css.FILLER_BOX_CLASS),s=e.children("."+wi.css.CLOSE_BUTTON_CLASS),o=$(document).outerHeight(),r=$(window).outerWidth(),l=$(window).outerHeight(),a=t.outerWidth(),c=t.outerHeight(),d=parseInt(e.css("min-width"),10);d=a>d?a:d;var h=parseInt(e.css("border-width"),10);e.css("width",d);var g=c+e.height(),u=t.offset(),E={top:u.top-h,left:u.left-h,right:u.left+d+h,bottom:u.top+g+h},w={},m={},f={};E.right>r?(w.left="initial",w.right=r-(u.left+a+h),f.left=0,f.right="initial",s.addClass("top left")):(w.left=E.left,w.right="initial",f.left="initial",f.right=0,s.addClass("top right")),E.bottom>o?(w.top="initial",w.bottom=l-(u.top+c+h),m.paddingTop=0,m.paddingBottom=h/2,m.marginTop=0,m.marginBottom=c,f.top="initial",f.bottom=0):(w.top=E.top,w.bottom="initial",m.paddingTop=h/2,m.paddingBottom=0,m.marginTop=c,m.marginBottom=0,f.top=0,f.bottom="initial"),d>a?(f.width=d-a,f.height=c,f.display="block"):f.display="none",n.css(f),i.css(m),e.css(w)},remove:function(){wi.current.contentBox.remove(),wi.current.element=$()}},utils:{colors:{rgbRegex:/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/,hexDigits:["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"],isRgb:function(e){return 4===rgb.match(this.rgbRegex).length},rgb2hex:function(e){return e=e.match(this.rgbRegex),"#"+this.hex(e[1])+this.hex(e[2])+this.hex(e[3])},hex:function(e){return isNaN(e)?"00":this.hexDigits[(e-e%16)/16]+this.hexDigits[e%16]}},parseColor:function(e){return"transparent"==e?"":e},parseBackgroundImage:function(e){return"url"==e.substr(0,3)?this.parseSourceURL(e.replace("url(","").replace(")","")):""},parseSourceURL:function(e){return e&&-1==e.indexOf("://")&&(e=window.location.protocol+"//"+window.location.host+(window.location.port?":"+window.location.port:"")+("/"==e.charAt(0)?"":"/")+e),e}}};wi.elements.init();