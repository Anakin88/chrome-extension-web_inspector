const wi={css:{ELEMENT:'chrome-extension-wi-element',COLOR_SELECT_CLASS:'chrome-extension-wi-color_select',CLOSE_BUTTON_CLASS:'chrome-extension-wi-close_button',CONTENT_BOX_CLASS:'chrome-extension-wi-content_box',DATA_BOX_CLASS:'chrome-extension-wi-data_box',DATA_FIELD:'chrome-extension-wi-data_field',FILLER_BOX_CLASS:'chrome-extension-wi-filler_box'},current:{active:!1,contentBox:$(),element:$(),elements:$(),addElements(a){0<a.length&&(a.addClass(wi.css.ELEMENT).on('click',wi.events.elementClick),this.elements=this.elements.add(a))},resetElements(){this.elements.removeClass(wi.css.ELEMENT).off('click',wi.events.elementClick),this.elements=$()},toggleStatus(){const a=wi.elements;let b='';this.active=!this.active,this.active?(b='on',this.addElements($(a.selector).filter(a.filter))):(b='off',this.resetElements(),wi.box.remove()),$(document)[b]('click',wi.events.documentClicked)[b]('DOMNodeInserted',wi.events.elementCreated),$(window)[b]('keydown',wi.events.keyPress)[b]('resize scroll',wi.events.windowResizeOrScroll)}},elements:{selector:'',containers:'',filter:'',CONTENT:['ARTICLE','ASIDE','DIV','FIELDSET','FOOTER','FORM','HEADER','MAIN','NAV','OL','SECTION','TABLE','UL'],FORM:['BUTTON','INPUT','KEYGEN','OUTPUT','SELECT','TEXTAREA'],GAME:['CANVAS'],MULTIMEDIA:['AUDIO','IMG','VIDEO'],REFERENCE:['A','IFRAME','EMBED','OBJECT'],TEXT:['ABBR','ADDRESS','B','BDI','BDO','BLOCKQUOTE','CAPTION','CITE','CODE','DD','DEL','DIV','DFN','DIALOG','DT','EM','FIGCAPTION','H1','H2','H3','H4','H5','H6','I','INS','LABEL','LEGEND','LI','MARK','P','PRE','Q','S','SAMP','SMALL','SPAN','STRONG','SUB','SUMMARY','SUP','TIME','TH','TD','U','VAR'],init(){this.selector=this.REFERENCE.join(',')+','+this.TEXT.join(',')+','+this.MULTIMEDIA.join(','),this.containers=this.CONTENT.join(','),this.filter=':not(:has('+this.containers+'))'}},events:{documentClicked(){wi.current.active&&wi.box.remove()},elementCreated(a){if(wi.current.active){const b=$(a.target),c=wi.elements;if(!b.hasClass(wi.css.CONTENT_BOX_CLASS)){let a=b.find(c.selector).filter(c.filter).filter(':not(.'+wi.css.ELEMENT+')');!b.hasClass(wi.css.ELEMENT)&&b.is(c.selector)&&0==b.find(c.containers).length&&(a=a.add(b)),wi.current.addElements(a)}}},elementClick(a){wi.current.active&&(a.preventDefault(),a.stopPropagation(),wi.box.remove(),wi.box.add($(a.target)))},keyPress(a){console.log(a.keyCode),wi.current.active&&27==a.keyCode&&chrome.extension.sendRequest({action:'toggleIcon'})},windowResizeOrScroll(){wi.current.active&&0<wi.current.contentBox.length&&0<wi.current.element.length&&wi.box.setStyles(wi.current.contentBox,wi.current.element)}},box:{add(a){const b=$('<div class="'+wi.css.CONTENT_BOX_CLASS+'"></div>'),c=$('<div class="'+wi.css.DATA_BOX_CLASS+'"></div>'),d=$('<div class="'+wi.css.FILLER_BOX_CLASS+'"></div>'),e=$('<div class="'+wi.css.CLOSE_BUTTON_CLASS+'">X</div>'),f=this.getMetadata(a);let g='<form>';for(let b=0;b<f.length;b++){const a=f[b];a.value&&(g+=`<div class="${wi.css.DATA_FIELD}">
							<label for="${a.id}">${a.label}:</label>`+(-1==a.id.indexOf('src')?`<span>${a.value}</span>`:`<a href="${a.value}" target="_blank">${a.value}</a>`)+(-1==a.id.indexOf('color')?'':`<select class="${wi.css.COLOR_SELECT_CLASS}">
									<option value="hex">HEX</option>
									<option value="rgb" selected>RGB</option>
								</select>`)+'</div>')}g+='<form>',b.on('click',(a)=>{a.stopPropagation()}).on('change','select.'+wi.css.COLOR_SELECT_CLASS,(a)=>{const b=$(a.currentTarget),c=b.prev(),d=b.val(),e=c.data('rgb')||c.text(),f=c.data('hex')||wi.utils.colors.rgb2hex(e);c.data({rgb:e,hex:f});'rgb'===d?c.text(e):'hex'===d?c.text(f):void 0}),e.on('click',wi.events.documentClicked),c.append(g),b.append(e),b.append(c),b.append(d),$('body').append(b),this.setStyles(b,a),wi.current.contentBox=b,wi.current.element=a},getMetadata(a){const b=[],c=[],d=[],e=a[0].tagName,f=a.text(),g=wi.utils.parseColor(a.css('color')),h=wi.utils.parseColor(a.css('background-color')),i=wi.utils.parseBackgroundImage(a.css('background-image')),j=wi.utils.parseSourceURL(a.attr('href')),k=wi.utils.parseSourceURL(a.attr('src')||a.children('source').attr('src'));return f&&'string'==typeof f&&b.push({id:'font',label:chrome.i18n.getMessage('fieldFontLabel'),value:a.css('font-family')},{id:'fsize',label:chrome.i18n.getMessage('fieldFSizeLabel'),value:a.css('font-size')},{id:'text-color',label:chrome.i18n.getMessage('fieldTextColorLabel'),value:g},{id:'background-color',label:chrome.i18n.getMessage('fieldBackgroundColorLabel'),value:h}),wi.elements.REFERENCE.includes(e)&&c.push({id:'src',label:chrome.i18n.getMessage('fieldSourceLabel'),value:j||k},{id:'lang',label:chrome.i18n.getMessage('fieldLangLabel'),value:a.attr('hreflang')}),(wi.elements.MULTIMEDIA.includes(e)||i)&&d.push({id:'width',label:chrome.i18n.getMessage('fieldWidthLabel'),value:a.width()+'px'},{id:'height',label:chrome.i18n.getMessage('fieldHeightLabel'),value:a.height()+'px'},{id:'src',label:chrome.i18n.getMessage('fieldSourceLabel'),value:k},{id:'desc',label:chrome.i18n.getMessage('fieldDescLabel'),value:a.attr('alt')},{id:'image-src',label:chrome.i18n.getMessage('fieldBackgroundImageLabel'),value:i}),[...b,...c,...d]},setStyles(a,b){const c=a.children('.'+wi.css.DATA_BOX_CLASS),d=a.children('.'+wi.css.FILLER_BOX_CLASS),e=a.children('.'+wi.css.CLOSE_BUTTON_CLASS),f=$(document).outerHeight(),g=$(window).outerWidth(),h=$(window).outerHeight(),i=b.outerWidth(),j=b.outerHeight();let k=parseInt(a.css('min-width'),10);k=i>k?i:k;const l=parseInt(a.css('border-width'),10);a.css('width',k);const m=j+a.height(),n=b.offset(),o={top:n.top-l,left:n.left-l,right:n.left+k+l,bottom:n.top+m+l},p={},q={},r={};o.right>g?(p.left='initial',p.right=g-(n.left+i+l),r.left=0,r.right='initial',e.addClass('top left')):(p.left=o.left,p.right='initial',r.left='initial',r.right=0,e.addClass('top right')),o.bottom>f?(p.top='initial',p.bottom=h-(n.top+j+l),q.paddingTop=0,q.paddingBottom=l/2,q.marginTop=0,q.marginBottom=j,r.top='initial',r.bottom=0):(p.top=o.top,p.bottom='initial',q.paddingTop=l/2,q.paddingBottom=0,q.marginTop=j,q.marginBottom=0,r.top=0,r.bottom='initial'),k>i?(r.width=k-i,r.height=j,r.display='block'):r.display='none',d.css(r),c.css(q),a.css(p)},remove(){wi.current.contentBox.remove(),wi.current.element=$()}},utils:{colors:{rgbRegex:/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/,hexDigits:['0','1','2','3','4','5','6','7','8','9','a','b','c','d','e','f'],isRgb(){return 4===rgb.match(this.rgbRegex).length},rgb2hex(a){return a=a.match(this.rgbRegex),'#'+this.hex(a[1])+this.hex(a[2])+this.hex(a[3])},hex(a){return isNaN(a)?'00':this.hexDigits[(a-a%16)/16]+this.hexDigits[a%16]}},parseColor(a){return'transparent'==a?'':a},parseBackgroundImage(a){return'url'==a.substr(0,3)?this.parseSourceURL(a.replace('url(','').replace(')','')):''},parseSourceURL(a){return a&&-1==a.indexOf('://')&&(a=window.location.protocol+'//'+window.location.host+(window.location.port?':'+window.location.port:'')+('/'==a.charAt(0)?'':'/')+a),a}}};wi.elements.init();